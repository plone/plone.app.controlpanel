Search control panel
====================

Test setup::

    >>> app = layer['app']
    >>> from plone.testing.z2 import Browser
    >>> browser = Browser(app)
    >>> browser.handleErrors = False
    >>> browser.addHeader('Authorization', 'Basic admin:secret')
    >>> portal = layer['portal']
    >>> from Products.CMFCore.utils import getToolByName
    >>> jstool = getToolByName(portal, 'portal_javascripts')
    >>> site_props = portal.portal_properties.site_properties


Viewing the search control panel
--------------------------------

    >>> browser.open('http://nohost/plone/@@search-controlpanel')
    >>> browser.url.endswith('search-controlpanel')
    True

Click the save button without making any changes:

    >>> browser.getControl('Save').click()
    >>> browser.url.endswith('search-controlpanel')
    True

We should get a status message:

    >>> 'Changes saved.' in browser.contents
    True

Now click the cancel button:

    >>> browser.getControl('Cancel').click()
    >>> browser.url.endswith('plone_control_panel')
    True

There should be still no changes:

    >>> 'Changes canceled.' in browser.contents
    True

Make some changes
-----------------

    >>> browser.open('http://nohost/plone/@@search-controlpanel')
    >>> browser.url.endswith('search-controlpanel')
    True

    >>> browser.getControl('Enable LiveSearch').selected = False
    >>> browser.getControl(name='form.widgets.types_not_searched:list').value = ['Document', 'Event']


Click the save button:

    >>> browser.getControl('Save').click()
    >>> browser.url.endswith('search-controlpanel')
    True

We should be informed that something has changed:

    >>> 'Changes saved.' in browser.contents
    True

Make sure the changes have been applied correctly to the registry:

    >>> from zope.component import getUtility
    >>> from plone.registry.interfaces import IRegistry
    >>> from plone.app.controlpanel.interfaces import ISearchSchema

    >>> registry = getUtility(IRegistry)
    >>> settings = registry.forInterface(ISearchSchema)
    >>> settings.enable_livesearch
    False
    >>> 'Document' in settings.types_not_searched
    False
    >>> 'Event' in settings.types_not_searched
    False
    >>> 'Plone Site' in settings.types_not_searched
    True

Make sure the changes have been applied correctly to the tool:

    >>> site_props.enable_livesearch
    False

    >>> jstool.getResource('livesearch.js').getEnabled()
    False

    >>> 'Event' in site_props.types_not_searched
    False

    >>> 'Document' in site_props.types_not_searched
    False

    >>> 'File' in site_props.types_not_searched
    True

So called 'bad types' are not listed in the search panel, but they
should still be listed in the site_properties as not searchable:

    >>> from plone.app.vocabularies.types import BAD_TYPES
    >>> [bad for bad in BAD_TYPES if bad not in site_props.types_not_searched]
    []
