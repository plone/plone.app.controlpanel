Skins control panel
===================

Test setup::

    >>> app = layer['app']
    >>> from plone.testing.z2 import Browser
    >>> browser = Browser(app)
    >>> browser.handleErrors = False
    >>> browser.addHeader('Authorization', 'Basic admin:secret')
    >>> portal = layer['portal']
    >>> from Products.CMFCore.utils import getToolByName
    >>> stool = getToolByName(portal, 'portal_skins')

Fake a second available skin:

    >>> stool.selections['TestSkin'] = 'test_path'

Make sure we assume the right defaults
--------------------------------------

    >>> stool.default_skin
    'Sunburst Theme'

    >>> stool.getSkinSelections()
    ['Plone Default', 'Sunburst Theme', 'TestSkin']

Viewing the skins control panel
-------------------------------

    >>> browser.open('http://nohost/plone/@@skins-controlpanel')
    >>> browser.url.endswith('skins-controlpanel')
    True

Click the cancel button:

    >>> browser.getControl("Cancel").click()
    >>> browser.url.endswith('plone_control_panel')
    True

There should be still no changes:

    >>> 'Changes canceled.' in browser.contents
    True

Make some changes
-----------------

    >>> browser.open('http://nohost/plone/@@skins-controlpanel')
    >>> browser.url.endswith('skins-controlpanel')
    True

    >>> browser.getControl(name='form.widgets.theme:list').value = ('Plone Default', )

Click the save button:

    >>> browser.getControl("Save").click()
    >>> browser.url.endswith('skins-controlpanel')
    True

Make sure the changes have been applied correctly to the mailhost:

    >>> stool.default_skin
    'Plone Default'


External link marking and windows settings are also controlled here
-------------------------------------------------------------------

We should be starting with mark_special_links.js disabled:

    >>> jstool = getToolByName(portal, 'portal_javascripts')
    >>> jstool.getResource('mark_special_links.js').getEnabled()
    False

The mark_special_links and ext_links_open_new_window properties should also
false:

    >>> ptool = getToolByName(portal, 'portal_properties')
    >>> site_props = ptool.site_properties
    >>> site_props.external_links_open_new_window
    'false'

    >>> site_props.mark_special_links
    'false'

mark_special_links and ext_links_open_new_windowshould be initially unchecked
in the browser:

    >>> browser.open('http://nohost/plone/@@skins-controlpanel')
    >>> browser.getControl(name='form.mark_special_links').value
    False

    >>> browser.getControl(name='form.ext_links_open_new_window').value
    False

Checking mark_special_items should enable the js support and set the site prop:

    >>> browser.getControl(name='form.mark_special_links').value = True
    >>> browser.getControl("Save").click()
    >>> site_props.mark_special_links
    'true'

    >>> jstool.getResource('mark_special_links.js').getEnabled()
    True

Checking ext_links_open_new_window should enable the js support and set the site prop:

    >>> browser.getControl(name='form.ext_links_open_new_window').value = True
    >>> browser.getControl("Save").click()
    >>> site_props.external_links_open_new_window
    'true'

    >>> jstool.getResource('mark_special_links.js').getEnabled()
    True

Unchecking mark_special_links while new_window is set should leave the js
support in place since it's needed to support new_window:

    >>> browser.getControl(name='form.mark_special_links').value = False
    >>> browser.getControl("Save").click()
    >>> site_props.mark_special_links
    'false'

    >>> jstool.getResource('mark_special_links.js').getEnabled()
    True

Unchecking new_window should finally turn off the js support:

    >>> browser.getControl(name='form.ext_links_open_new_window').value = False
    >>> browser.getControl("Save").click()
    >>> site_props.external_links_open_new_window
    'false'

    >>> jstool.getResource('mark_special_links.js').getEnabled()
    False


Overlayed popup forms are also controlled here
-------------------------------------------------------------------

We should be starting with popupforms.js enabled:

    >>> jstool = getToolByName(portal, 'portal_javascripts')
    >>> jstool.getResource('popupforms.js').getEnabled()
    True

Unchecking use_popups should turn off the js support:

    >>> browser.getControl(name='form.use_popups').value = False
    >>> browser.getControl("Save").click()
    >>> jstool.getResource('popupforms.js').getEnabled()
    False

Checking use_popups should turn re-enable:

    >>> browser.getControl(name='form.use_popups').value = True
    >>> browser.getControl("Save").click()
    >>> jstool.getResource('popupforms.js').getEnabled()
    True
